# syntax=docker/dockerfile:1
FROM nixos/nix as builder
WORKDIR /scratch

# Setup nix in its own layer so it can be cached.
COPY ./default.nix .
RUN nix-env -if default.nix

COPY . .
RUN {{.InstallCommand}}
RUN {{.BuildCommand}}

FROM gcr.io/distroless/base:debug

# TODO: Improve to only copy needed files and not the entire src directory.
COPY --from=builder /scratch /app
WORKDIR app
ENTRYPOINT ["{{.StartCommand}}"] # TODO: support start command with additional args
